@model AdminTourGuideDetailsViewModel
@using Tourest.Helpers
@inject IConfiguration Configuration

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Chi tiết Hướng dẫn viên";
    var cloudName = Configuration["CloudinarySettings:CloudName"];
    var defaultAvatar = "assets/images/default-avatar.png";
}

<div class="container-fluid py-4">
    <!-- Header với breadcrumb -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">@Model.FullName</h2>
            <p class="text-muted">ID: @Model.UserId</p>
        </div>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.UserId" class="btn btn-primary">
                <i class="fas fa-edit me-2"></i>Sửa thông tin
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
            </a>
        </div>
    </div>

    <!-- Status card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="bg-light p-3 rounded-top d-flex align-items-center">
                <div class="status-indicator me-3 @(Model.IsActive ? "bg-success" : "bg-danger")"
                     style="width: 12px; height: 12px; border-radius: 50%;"></div>
                <h6 class="mb-0">Trạng thái: @(Model.IsActive ? "Hoạt động" : "Vô hiệu hóa")</h6>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Profile card -->
        <div class="col-md-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="position-relative mx-auto mb-4" style="width: 150px;">
                        <div class="avatar-container rounded-circle overflow-hidden mx-auto" style="width: 150px; height: 150px;">
                            <img src="@CloudinaryHelper.GetThumbnailUrl(Model.ProfilePictureUrl, 300, 300, cloudName, defaultAvatar)"
                                 alt="Ảnh đại diện của @Model.FullName" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;" />
                        </div>
                        @if (Model.AverageRating.HasValue)
                        {
                            <div class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px; transform: translate(10%, 10%);">
                                <div>
                                    <strong>@Model.AverageRating.Value.ToString("0.0")</strong>
                                    <div class="small">/ 5.0</div>
                                </div>
                            </div>
                        }
                    </div>

                    <h4 class="card-title mb-1">@Model.FullName</h4>
                    <p class="text-muted">@(Model.Specializations ?? "Chưa có chuyên môn")</p>

                    <div class="mt-4">
                        <div class="d-flex justify-content-center mb-3">
                            <div class="badge bg-light text-dark me-2 p-2">
                                <i class="fas fa-language me-1"></i> @(Model.LanguagesSpoken ?? "Chưa cập nhật")
                            </div>
                            <div class="badge bg-light text-dark p-2">
                                <i class="fas fa-award me-1"></i> @(Model.ExperienceLevel ?? "Chưa cập nhật")
                            </div>
                        </div>

                        <div class="d-flex justify-content-around mt-4">
                            @if (!string.IsNullOrEmpty(Model.Email))
                            {
                                <a href="mailto:@Model.Email" class="btn btn-sm btn-outline-primary rounded-circle"
                                   data-bs-toggle="tooltip" title="Email: @Model.Email">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                            {
                                <a href="tel:@Model.PhoneNumber" class="btn btn-sm btn-outline-primary rounded-circle"
                                   data-bs-toggle="tooltip" title="Điện thoại: @Model.PhoneNumber">
                                    <i class="fas fa-phone"></i>
                                </a>
                            }
                            <button class="btn btn-sm btn-outline-primary rounded-circle"
                                    data-bs-toggle="tooltip" title="Chi tiết liên hệ">
                                <i class="fas fa-id-card"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0">
                    <div class="row text-center">
                        <div class="col border-end">
                            <h6 class="mb-0">@Model.AssignmentsLed.Count()</h6>
                            <small class="text-muted">Tours đã dẫn</small>
                        </div>
                        <div class="col border-end">
                            <h6 class="mb-0">@Model.RatingsReceived.Count()</h6>
                            <small class="text-muted">Đánh giá</small>
                        </div>
                        <div class="col">
                            <h6 class="mb-0">@(Model.MaxCapacity?.ToString() ?? "∞")</h6>
                            <small class="text-muted">Sức chứa</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info card -->
        <div class="col-md-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="tourGuideTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane"
                                    type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true">
                                <i class="fas fa-info-circle me-2"></i>Thông tin
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tours-tab" data-bs-toggle="tab" data-bs-target="#tours-tab-pane"
                                    type="button" role="tab" aria-controls="tours-tab-pane" aria-selected="false">
                                <i class="fas fa-route me-2"></i>Tours
                                <span class="badge bg-primary ms-1">@Model.AssignmentsLed.Count()</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews-tab-pane"
                                    type="button" role="tab" aria-controls="reviews-tab-pane" aria-selected="false">
                                <i class="fas fa-star me-2"></i>Đánh giá
                                <span class="badge bg-primary ms-1">@Model.RatingsReceived.Count()</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="tourGuideTabContent">
                        <!-- Info Tab -->
                        <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                            <div class="row">
                                <div class="col-lg-6">
                                    <h5 class="mb-3">Thông tin cá nhân</h5>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Họ và tên</label>
                                        <p class="mb-3">@Model.FullName</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Email</label>
                                        <p class="mb-3">@Model.Email</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Số điện thoại</label>
                                        <p class="mb-3">@Model.PhoneNumber</p>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <h5 class="mb-3">Thông tin bổ sung</h5>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Địa chỉ</label>
                                        <p class="mb-3">@Model.Address</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Ngày đăng ký</label>
                                        <p class="mb-3">@Model.RegistrationDate.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Sức chứa tối đa</label>
                                        <p class="mb-3">@(Model.MaxCapacity.HasValue ? Model.MaxCapacity.Value.ToString() : "Không giới hạn")</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tours Tab -->
                        <div class="tab-pane fade" id="tours-tab-pane" role="tabpanel" aria-labelledby="tours-tab" tabindex="0">
                            @if (Model.AssignmentsLed.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tên Tour</th>
                                                <th>Ngày đi</th>
                                                <th>Trạng thái</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var assignment in Model.AssignmentsLed)
                                            {
                                                <tr>
                                                    <td>@assignment.AssignmentId</td>
                                                    <td>@assignment.TourName</td>
                                                    <td>@(assignment.DepartureDate?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                                    <td>
                                                        @{
                                                            string badgeClass = "bg-secondary";

                                                            if (assignment.AssignmentStatus == "Hoàn thành")
                                                                badgeClass = "bg-success";
                                                            else if (assignment.AssignmentStatus == "Đang thực hiện")
                                                                badgeClass = "bg-primary";
                                                            else if (assignment.AssignmentStatus == "Đã hủy")
                                                                badgeClass = "bg-danger";
                                                            else if (assignment.AssignmentStatus == "Chờ xác nhận")
                                                                badgeClass = "bg-warning text-dark";
                                                        }
                                                        <span class="badge @badgeClass">@assignment.AssignmentStatus</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <a href="#" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="fas fa-route fa-3x text-muted mb-3"></i>
                                    <h5>Chưa có chuyến đi nào</h5>
                                    <p class="text-muted">Hướng dẫn viên này chưa nhận chuyến đi nào.</p>
                                </div>
                            }
                        </div>

                        <!-- Reviews Tab -->
                        <div class="tab-pane fade" id="reviews-tab-pane" role="tabpanel" aria-labelledby="reviews-tab" tabindex="0">
                            @if (Model.RatingsReceived.Any())
                            {
                                <div class="mb-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary text-white rounded p-2 me-3">
                                            <h2 class="mb-0">@Model.AverageRating?.ToString("0.0")</h2>
                                        </div>
                                        <div>
                                            <div class="mb-1">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="@(i <= Math.Round(Model.AverageRating ?? 0) ? "fas" : "far") fa-star text-warning"></i>
                                                }
                                            </div>
                                            <p class="text-muted mb-0">Dựa trên @Model.RatingsReceived.Count() đánh giá</p>
                                        </div>
                                    </div>
                                </div>

                                @foreach (var rating in Model.RatingsReceived)
                                {
                                    <div class="card mb-3 border-0 bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">@rating.CustomerName</h6>
                                                <small class="text-muted">@rating.RatingDate.ToString("dd/MM/yyyy")</small>
                                            </div>
                                            <div class="mb-2">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="@(i <= rating.RatingValue ? "fas" : "far") fa-star text-warning small"></i>
                                                }
                                                <span class="ms-2">@rating.RatingValue.ToString("0.0")</span>
                                            </div>
                                            <p class="card-text mb-0">@rating.Comment</p>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                    <h5>Chưa có đánh giá nào</h5>
                                    <p class="text-muted">Hướng dẫn viên này chưa nhận được đánh giá nào.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Initialize tooltips -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>